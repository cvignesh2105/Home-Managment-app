<!DOCTYPE html>
<html lang="ta" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роХрпБроЯрпБроорпНрок рокрогрпНроЯроЩрпНроХро│рпН роорпЗро▓ро╛рогрпНроорпИ | Premium Family Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .importance-high { border-left: 4px solid #ef4444; }
        .importance-medium { border-left: 4px solid #f59e0b; }
        .importance-low { border-left: 4px solid #10b981; }

        .priority-critical { background: linear-gradient(135deg, #fee2e2, #fecaca) !important; }
        .priority-high { background: linear-gradient(135deg, #fef3c7, #fde68a) !important; }
        .priority-normal { background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important; }

        .progress-bar {
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.5s ease-in-out;
            height: 6px;
            border-radius: 3px;
        }

        /* Better touch targets for mobile */
        .btn, .nav-tab {
            min-height: 44px;
            min-width: 44px;
        }

        /* Prevent zoom on input focus for iOS */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-gray-700 transition-colors duration-300">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-shopping-basket text-3xl text-blue-600 dark:text-blue-400"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white" id="appTitle">роХрпБроЯрпБроорпНрок рокрогрпНроЯроЩрпНроХро│рпН роорпЗро▓ро╛рогрпНроорпИ</h1>
                        <p class="text-gray-600 dark:text-gray-300 text-sm" id="activeTabTitle">роорпБроХрокрпНрокрпБ рокро▓роХрпИ</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Version Display -->
                    <div class="hidden md:block text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                        v<span id="appVersion">2.1.0</span>
                    </div>

                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <!-- Language Toggle -->
                    <button onclick="safeExecute(toggleLanguage)" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-lg font-semibold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors flex items-center space-x-2">
                        <i class="fas fa-globe"></i>
                        <span id="langCode">род</span>
                    </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div id="quickActions" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                <!-- Quick actions will be loaded here -->
            </div>
            
            <div id="errorAlert" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900 dark:border-red-700 dark:text-red-200"></div>
            <div id="successAlert" class="hidden mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg dark:bg-green-900 dark:border-green-700 dark:text-green-200"></div>
            <div id="notification" class="hidden mt-4 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200"></div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-2 mb-6 border border-gray-200 dark:border-gray-700 transition-colors duration-300">
            <div class="flex space-x-1 overflow-x-auto">
                <button onclick="safeExecute(() => showTab('home'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 bg-blue-600 text-white" data-tab="home">
                    <i class="fas fa-home"></i>
                    <span id="tabHome">роорпБроХрокрпНрокрпБ рокро▓роХрпИ</span>
                </button>
                <button onclick="safeExecute(() => showTab('stock'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="stock">
                    <i class="fas fa-boxes"></i>
                    <span id="tabStock">роЗро░рпБрокрпНрокрпБ роорпЗро▓ро╛рогрпНроорпИ</span>
                </button>
                <button onclick="safeExecute(() => showTab('storeRoom'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="storeRoom">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="tabStoreRoom">ро╖ро╛рокрпНрокро┐роЩрпН ро╡рогрпНроЯро┐</span>
                </button>
                <button onclick="safeExecute(() => showTab('prices'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="prices">
                    <i class="fas fa-chart-line"></i>
                    <span id="tabPrices">рокроХрпБрокрпНрокро╛ропрпНро╡рпБ</span>
                </button>
                <button onclick="safeExecute(() => showTab('finance'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="finance">
                    <i class="fas fa-wallet"></i>
                    <span id="tabFinance">роиро┐родро┐рокрпН рокродро┐ро╡рпЗроЯрпБ</span>
                </button>
                <button onclick="safeExecute(() => showTab('settings'))" class="nav-tab flex items-center space-x-2 px-4 py-3 rounded-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span id="tabSettings">роЕроорпИрокрпНрокрпБроХро│рпН</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main>
            <!-- Loading State -->
            <div id="loadingState" class="flex flex-col items-center justify-center h-64 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 transition-colors duration-300">
                <div class="loading-spinner mb-4"></div>
                <p class="text-lg font-semibold text-gray-700 dark:text-gray-300" id="loadingText">роорпБроХрокрпНрокрпБ рокро▓роХрпИ роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="connectingText">роЕройрпИродрпНродрпБ роЕроорпНроЪроЩрпНроХро│рпБроорпН родрпБро╡роЩрпНроХрокрпНрокроЯрпБроХро┐ройрпНро▒рой...</p>
            </div>

            <!-- Tab Content -->
            <div id="tabContent" class="hidden fade-in">
                <!-- Content will be dynamically loaded here -->
            </div>
        </main>
    </div>

    <!-- Update Notification -->
    <div id="updateNotification" class="hidden fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm transition-all duration-300">
        <div class="flex justify-between items-start">
            <div>
                <h4 class="font-bold" id="updateTitle">New Update Available! ЁЯЪА</h4>
                <p class="text-sm opacity-90 mt-1" id="updateMessage">Refresh to get the latest features</p>
                <div class="text-xs mt-2 hidden" id="updateChangelog">
                    <strong>What's New:</strong>
                    <ul class="list-disc list-inside mt-1" id="changelogList"></ul>
                </div>
            </div>
            <button onclick="hideUpdateNotification()" class="text-white hover:text-gray-200 ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <button onclick="location.reload()" class="w-full bg-white text-blue-600 py-2 rounded font-semibold mt-2 hover:bg-gray-100 transition-colors">
            Refresh Now
        </button>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="modalTitle">рокрпБродро┐роп рокрпКро░рпБро│рпИроЪрпН роЪрпЗро░рпН</h3>
                    <button onclick="hideModal('addProductModal')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="addProductForm" onsubmit="safeExecute(handleAddProduct, event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">рокрпКро░рпБро│рпН ро╡роХрпИ</label>
                            <select id="productType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="Grocery">рооро│ро┐роХрпИ</option>
                                <option value="HomeEssentials">ро╡рпАроЯрпНроЯрпБ роЕродрпНродро┐ропро╛ро╡роЪро┐роп рокрпКро░рпБроЯрпНроХро│рпН</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">рокрпКро░рпБро│ро┐ройрпН рокрпЖропро░рпН</label>
                            <input type="text" id="productName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="роО.роХро╛: роЕро░ро┐роЪро┐" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роХрпБро▒рпИроирпНродрокроЯрпНроЪ роЗро░рпБрокрпНрокрпБ роиро┐ро▓рпИ</label>
                                <input type="number" id="minStock" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="1" value="1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роЕро│ро╡рпБ</label>
                                <select id="productScale" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                    <option value="Gram">роХро┐ро░ро╛роорпН</option>
                                    <option value="Kg">роХро┐ро▓рпЛ</option>
                                    <option value="Liter">ро▓ро┐роЯрпНроЯро░рпН</option>
                                    <option value="Pack">рокрпЗроХрпН</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роХроЯрпИроЪро┐ роЕро▓роХрпБ ро╡ро┐ро▓рпИ</label>
                            <input type="number" id="lastPrice" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0" step="0.01" placeholder="тВ╣" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ро╡ро╛роЩрпНроХрпБроорпН роЕродро┐ро░рпНро╡рпЖрогрпН</label>
                                <select id="frequency" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                    <option value="Weekly">ро╡ро╛ро░ро╛роирпНродро┐ро░</option>
                                    <option value="Monthly">рооро╛родро╛роирпНродро┐ро░</option>
                                    <option value="BiMonthly">роЗро░рпБ рооро╛род</option>
                                    <option value="3Months">3 рооро╛родроЩрпНроХро│рпН</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роорпБроХрпНроХро┐ропродрпНродрпБро╡роорпН</label>
                                <select id="importance" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                    <option value="3">роЕродро┐роХроорпН (тШЕтШЕтШЕ)</option>
                                    <option value="2">роородрпНродро┐роороорпН (тШЕтШЕтШЖ)</option>
                                    <option value="1">роХрпБро▒рпИро╡рпБ (тШЕтШЖтШЖ)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-save"></i>
                            <span id="addProductButton">рокрпКро░рпБро│рпН роЪрпЗро░рпНроХрпНроХ</span>
                        </button>
                        <button type="button" onclick="hideModal('addProductModal')" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                            <span id="cancelButton">ро░родрпНродрпБ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">рокрпБродро┐роп роЪрпЖро▓ро╡рпБ</h3>
                    <button onclick="hideModal('addExpenseModal')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <form id="addExpenseForm" onsubmit="safeExecute(handleAddExpense, event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роЪрпЖро▓ро╡рпБ рокрпЖропро░рпН</label>
                            <input type="text" id="expenseName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="роО.роХро╛: рооро┐ройрпНроЪро╛ро░ рокро┐ро▓рпН" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">родрпКроХрпИ</label>
                            <input type="number" id="expenseAmount" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" min="0" step="0.01" placeholder="тВ╣" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ро╡роХрпИ</label>
                            <select id="expenseType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="Fixed">роиро┐ро▓рпИропро╛рой</option>
                                <option value="Variable">рооро╛ро▒рпБроорпН</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                            роЪрпЖро▓ро╡рпБ роЪрпЗро░рпНроХрпНроХ
                        </button>
                        <button type="button" onclick="hideModal('addExpenseModal')" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                            ро░родрпНродрпБ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Data Management Modal -->
    <div id="dataManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white">родро░ро╡рпБ роорпЗро▓ро╛рогрпНроорпИ</h3>
                    <button onclick="hideModal('dataManagementModal')" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">родро░ро╡рпБ роХро╛рокрпНрокрпБрокрпНрокродро┐ро╡рпБ</h4>
                        <button onclick="safeExecute(exportData)" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-download"></i>
                            <span>роХро╛рокрпНрокрпБрокрпНрокродро┐ро╡рпИ рокродро┐ро╡ро┐ро▒роХрпНроХ</span>
                        </button>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">роЙроЩрпНроХро│рпН роЕройрпИродрпНродрпБ родро░ро╡рпИропрпБроорпН JSON роХрпЛрокрпНрокро╛роХ рокродро┐ро╡ро┐ро▒роХрпНроХ</p>
                    </div>
                    
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">родро░ро╡рпБ роЗро▒роХрпНроХрпБроородро┐</h4>
                        <input type="file" id="importFile" accept=".json" class="hidden">
                        <button onclick="document.getElementById('importFile').click()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-upload"></i>
                            <span>роХро╛рокрпНрокрпБрокрпНрокродро┐ро╡рпИ роПро▒рпНро▒</span>
                        </button>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">роорпБройрпНрокрпБ рокродро┐ро╡ро┐ро▒роХрпНроХро┐роп JSON роХрпЛрокрпНрокрпИ роПро▒рпНро▒</p>
                    </div>
                    
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 class="font-semibold text-red-700 dark:text-red-400 mb-3">роЕрокро╛ропроХро░рооро╛рой роЕроорпИрокрпНрокрпБроХро│рпН</h4>
                        <button onclick="safeExecute(clearAllData)" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-trash"></i>
                            <span>роЕройрпИродрпНродрпБ родро░ро╡рпИропрпБроорпН роирпАроХрпНроХ</span>
                        </button>
                        <p class="text-xs text-red-500 dark:text-red-400 mt-2">тЪая╕П роЗроирпНрод роЪрпЖропро▓рпИ родро┐ро░рпБроорпНрок рокрпЖро▒ роорпБроЯро┐ропро╛родрпБ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw7agc8kXiZlGkaVmjFpnLsfQnuTuSR6xSp2w-oMbSDrWjAcyHBp_54rEy1J4kOZl5ilA/exec';
        const APP_VERSION = '2.1.0';

        // ==================== ERROR BOUNDARY & SAFETY ====================
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showError('Something went wrong. Please refresh the page.');
        });

        function safeExecute(fn, ...args) {
            try {
                return fn(...args);
            } catch (error) {
                console.error('Execution error:', error);
                showError('An error occurred. Please try again.');
                return null;
            }
        }

        // ==================== TRANSLATIONS ====================
        const translations = {
            en: {
                langCode: "En", appTitle: "Premium Family Finance",
                tabHome: "Dashboard", tabStock: "Inventory", tabStoreRoom: "Shopping Cart", tabPrices: "Analytics", tabFinance: "Financial Ledger", tabSettings: "Settings",
                monthlyIncome: "Monthly Income", totalSpent: "Total Spent", amountSaved: "Amount Saved", reserveCash: "Savings Target",
                addNewProduct: "Add New Product", productName: "Product Name", minStockQuantity: "Min Stock Level", lastPrice: "Last Unit Price",
                addProductButton: "Add Product", cancelButton: "Cancel",
                loading: "Loading Dashboard...", connectingDb: "Starting all features...", 
                error: "Error:", success: "Success:",
                shoppingList: "Items to Purchase", generateCart: "Cart Summary", totalItems: "Total Items:",
                estimatedBudget: "Estimated Budget:", proceedToBilling: "Proceed to Billing",
                incomeExpenseEntry: "Income & Expenses", totalIncome: "Total Income", expenses: "Expenses",
                addNewExpense: "Add Expense", financialSummary: "Financial Summary", totalSpentSummary: "Total Spent",
                amountSavedSummary: "Net Savings", reserveCashTarget: "Savings Target",
                quickAddProduct: "Add Product", quickAddExpense: "Add Expense", quickBackup: "Backup Data", quickCart: "Quick Cart"
            },
            ta: {
                langCode: "род", appTitle: "рокро┐ро░рпАрооро┐ропроорпН роХрпБроЯрпБроорпНрок роиро┐родро┐",
                tabHome: "роорпБроХрокрпНрокрпБ рокро▓роХрпИ", tabStock: "роЗро░рпБрокрпНрокрпБ роорпЗро▓ро╛рогрпНроорпИ", tabStoreRoom: "ро╖ро╛рокрпНрокро┐роЩрпН ро╡рогрпНроЯро┐", tabPrices: "рокроХрпБрокрпНрокро╛ропрпНро╡рпБ", tabFinance: "роиро┐родро┐рокрпН рокродро┐ро╡рпЗроЯрпБ", tabSettings: "роЕроорпИрокрпНрокрпБроХро│рпН",
                monthlyIncome: "рооро╛родро╛роирпНродро┐ро░ ро╡ро░рпБрооро╛ройроорпН", totalSpent: "роорпКродрпНрод роЪрпЖро▓ро╡рпБ", amountSaved: "роЪрпЗрооро┐родрпНрод родрпКроХрпИ", reserveCash: "роЪрпЗрооро┐рокрпНрокрпБ роЗро▓роХрпНроХрпБ",
                addNewProduct: "рокрпБродро┐роп рокрпКро░рпБро│рпИроЪрпН роЪрпЗро░рпН", productName: "рокрпКро░рпБро│ро┐ройрпН рокрпЖропро░рпН", minStockQuantity: "роХрпБро▒рпИроирпНродрокроЯрпНроЪ роЗро░рпБрокрпНрокрпБ роиро┐ро▓рпИ", lastPrice: "роХроЯрпИроЪро┐ роЕро▓роХрпБ ро╡ро┐ро▓рпИ",
                addProductButton: "рокрпКро░рпБро│рпН роЪрпЗро░рпНроХрпНроХ", cancelButton: "ро░родрпНродрпБ",
                loading: "роорпБроХрокрпНрокрпБ рокро▓роХрпИ роПро▒рпНро▒рокрпНрокроЯрпБроХро┐ро▒родрпБ...", connectingDb: "роЕройрпИродрпНродрпБ роЕроорпНроЪроЩрпНроХро│рпБроорпН родрпБро╡роЩрпНроХрокрпНрокроЯрпБроХро┐ройрпНро▒рой...", 
                error: "рокро┐ро┤рпИ:", success: "ро╡рпЖро▒рпНро▒ро┐:",
                shoppingList: "ро╡ро╛роЩрпНроХ ро╡рпЗрогрпНроЯро┐роп рокрпКро░рпБроЯрпНроХро│рпН", generateCart: "ро╡рогрпНроЯро┐ роЪрпБро░рпБроХрпНроХроорпН", totalItems: "роорпКродрпНрод рокрпКро░рпБроЯрпНроХро│рпН:",
                estimatedBudget: "роородро┐рокрпНрокро┐роЯрокрпНрокроЯрпНроЯ рокроЯрпНроЬрпЖроЯрпН:", proceedToBilling: "рокро┐ро▓рпНро▓ро┐роЩрпН роЪрпЖропрпНроп родрпКроЯро░",
                incomeExpenseEntry: "ро╡ро░рпБрооро╛ройроорпН рооро▒рпНро▒рпБроорпН роЪрпЖро▓ро╡рпБроХро│рпН", totalIncome: "роорпКродрпНрод ро╡ро░рпБрооро╛ройроорпН", expenses: "роЪрпЖро▓ро╡рпБроХро│рпН",
                addNewExpense: "роЪрпЖро▓ро╡рпБ роЪрпЗро░рпН", financialSummary: "роиро┐родро┐ роЪрпБро░рпБроХрпНроХроорпН", totalSpentSummary: "роорпКродрпНрод роЪрпЖро▓ро╡рпБ",
                amountSavedSummary: "роиро┐роХро░ роЪрпЗрооро┐рокрпНрокрпБ", reserveCashTarget: "роЪрпЗрооро┐рокрпНрокрпБ роЗро▓роХрпНроХрпБ",
                quickAddProduct: "рокрпКро░рпБро│рпН роЪрпЗро░рпН", quickAddExpense: "роЪрпЖро▓ро╡рпБ роЪрпЗро░рпН", quickBackup: "роХро╛рокрпНрокрпБрокрпНрокродро┐ро╡рпБ", quickCart: "ро╡ро┐ро░рпИро╡рпБ ро╡рогрпНроЯро┐"
            }
        };

        // ==================== APP STATE ====================
        let currentLanguage = localStorage.getItem('language') || 'ta';
        let currentTab = 'home';
        let appData = {
            products: [],
            expenses: [],
            electricityBills: [],
            income: 45000,
            shoppingCart: [],
            analytics: {},
            settings: {
                darkMode: false,
                notifications: true,
                autoBackup: true
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            safeExecute(initializeApp);
        });

        async function initializeApp() {
            try {
                // Initialize theme
                initializeTheme();
                
                // Check online status
                checkOnlineStatus();
                
                // Update UI with translations
                updateUI();
                
                // Load initial data
                await loadInitialData();
                
                // Setup quick actions
                setupQuickActions();
                
                // Check for alerts and notifications
                checkAlertsAndNotifications();
                
                // Initialize electricity bills
                initializeElectricityBills();
                
                // Hide loading, show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('tabContent').classList.remove('hidden');
                
                // Show home tab
                showTab('home');
                
                // Start periodic checks
                startPeriodicChecks();
                
                // Migrate data if needed
                migrateData();
                
            } catch (error) {
                showError('Failed to initialize app: ' + error.message);
            }
        }

        // ==================== OFFLINE SUPPORT ====================
        function checkOnlineStatus() {
            if (!navigator.onLine) {
                showNotification('You are offline. Data will be saved locally.', 'warning');
            }
        }

        window.addEventListener('online', () => {
            showNotification('Back online! Syncing data...', 'success');
            syncLocalData();
        });

        window.addEventListener('offline', () => {
            showNotification('You are offline. Working in local mode.', 'warning');
        });

        // ==================== THEME MANAGEMENT ====================
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            document.getElementById('themeToggle').addEventListener('click', function() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                this.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });
        }

        // ==================== DATA MANAGEMENT ====================
        async function loadInitialData() {
            try {
                // Try to load from Google Sheets with better error handling
                const productsData = await safeExecute(() => fetchSheetData('products')) || [];
                const expensesData = await safeExecute(() => fetchSheetData('expenses')) || [];
                
                appData.products = productsData;
                appData.expenses = expensesData;
                
                // Generate analytics
                generateAnalytics();
                
                // Generate shopping cart
                generateShoppingCart();
                
                showSuccess('Data loaded successfully!');
                
            } catch (error) {
                console.log('Using demo data due to:', error);
                // Fallback to demo data
                appData.products = [
                    { 
                        id: '1', name: 'рокро╛ро▓рпН', type: 'Grocery', 
                        stock_quantity: 2, current_stock: 0, 
                        scale: 'Liter', last_price: 65, 
                        frequency: 'Weekly', importance: 3 
                    },
                    { 
                        id: '2', name: 'роорпБроЯрпНроЯрпИ', type: 'Grocery', 
                        stock_quantity: 1, current_stock: 0, 
                        scale: 'Pack', last_price: 80, 
                        frequency: 'Weekly', importance: 2 
                    }
                ];
                
                appData.expenses = [
                    { id: '1', name: 'ро╡рпАроЯрпБ ро╡ро╛роЯроХрпИ', amount: 8300, type: 'Fixed' },
                    { id: '2', name: 'рооро┐ройрпНроЪро╛ро░ рокро┐ро▓рпН', amount: 1500, type: 'Variable' }
                ];
                
                generateAnalytics();
                generateShoppingCart();
                
                showSuccess('Using demo data. Real data will save to Google Sheets.');
            }
            
            // Load from localStorage as backup
            const localData = loadFromLocalStorage();
            if (localData) {
                Object.assign(appData, localData);
            }
        }

        // ==================== IMPROVED GOOGLE SHEETS INTEGRATION ====================
        async function fetchSheetData(sheetName) {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getData&sheet=${sheetName}&t=${Date.now()}`);
                if (!response.ok) throw new Error('Server error');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.data || [];
            } catch (error) {
                console.log('Failed to fetch from Google Sheets:', error);
                return [];
            }
        }

        async function addSheetData(sheetName, data) {
            try {
                // Validate data first
                const validationErrors = sheetName === 'products' ? 
                    validateProductData(data) : validateExpenseData(data);
                
                if (validationErrors.length > 0) {
                    throw new Error(validationErrors.join(', '));
                }

                const params = new URLSearchParams();
                params.append('action', 'addData');
                params.append('sheet', sheetName);
                
                Object.keys(data).forEach(key => {
                    params.append(key, data[key]);
                });
                
                const url = `${WEB_APP_URL}?${params.toString()}&t=${Date.now()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                return result;
                
            } catch (error) {
                console.error('API Error:', error);
                // Fallback: Save to localStorage
                saveToLocalStorage(sheetName, data);
                throw new Error('Saved locally. Will sync when online.');
            }
        }

        // ==================== DATA VALIDATION ====================
        function validateProductData(data) {
            const errors = [];
            if (!data.name || data.name.trim().length < 2) errors.push('Product name too short');
            if (!data.last_price || data.last_price <= 0) errors.push('Invalid price');
            if (!data.stock_quantity || data.stock_quantity <= 0) errors.push('Invalid stock quantity');
            return errors;
        }

        function validateExpenseData(data) {
            const errors = [];
            if (!data.name || data.name.trim().length < 2) errors.push('Expense name too short');
            if (!data.amount || data.amount <= 0) errors.push('Invalid amount');
            return errors;
        }

        // ==================== ELECTRICITY BILL MANAGEMENT ====================
        function initializeElectricityBills() {
            if (!appData.electricityBills || !Array.isArray(appData.electricityBills)) {
                appData.electricityBills = JSON.parse(localStorage.getItem('electricityBills')) || [];
            }
            updateElectricityBillDisplay();
        }

        function addElectricityBill() {
            const month = document.getElementById('billMonth').value;
            const year = document.getElementById('billYear').value;
            const amount = parseFloat(document.getElementById('billAmount').value);
            
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            const billId = `${year}-${month}`;
            
            const existingBillIndex = appData.electricityBills.findIndex(bill => bill.id === billId);
            
            if (existingBillIndex !== -1) {
                appData.electricityBills[existingBillIndex].amount = amount;
                appData.electricityBills[existingBillIndex].updatedAt = new Date().toISOString();
            } else {
                appData.electricityBills.push({
                    id: billId,
                    month: month,
                    year: year,
                    amount: amount,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
            
            appData.electricityBills.sort((a, b) => b.id.localeCompare(a.id));
            
            localStorage.setItem('electricityBills', JSON.stringify(appData.electricityBills));
            
            updateElectricityBillDisplay();
            
            document.getElementById('billAmount').value = '';
            
            showSuccess('Electricity bill added successfully!');
        }

        function updateElectricityBillDisplay() {
            const currentBillElement = document.getElementById('currentElectricityBill');
            const averageBillElement = document.getElementById('averageElectricityBill');
            const historyElement = document.getElementById('electricityBillHistory');
            
            if (!appData.electricityBills || appData.electricityBills.length === 0) {
                if (currentBillElement) currentBillElement.textContent = 'тВ╣0';
                if (averageBillElement) averageBillElement.textContent = 'тВ╣0';
                if (historyElement) historyElement.innerHTML = getEmptyState('No bills recorded yet', 'fas fa-bolt');
                return;
            }
            
            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYear = currentDate.getFullYear();
            const currentBillId = `${currentYear}-${currentMonth}`;
            
            const currentBill = appData.electricityBills.find(bill => bill.id === currentBillId);
            if (currentBillElement) {
                currentBillElement.textContent = currentBill ? `тВ╣${currentBill.amount.toLocaleString('en-IN')}` : 'тВ╣0';
            }
            
            const totalAmount = appData.electricityBills.reduce((sum, bill) => sum + bill.amount, 0);
            const averageAmount = totalAmount / appData.electricityBills.length;
            if (averageBillElement) {
                averageBillElement.textContent = `тВ╣${Math.round(averageAmount).toLocaleString('en-IN')}`;
            }
            
            if (historyElement) {
                historyElement.innerHTML = appData.electricityBills.map(bill => {
                    const monthNames = {
                        '01': 'роЬройро╡ро░ро┐ | Jan', '02': 'рокро┐рокрпНро░ро╡ро░ро┐ | Feb', '03': 'рооро╛ро░рпНроЪрпН | Mar',
                        '04': 'роПрокрпНро░ро▓рпН | Apr', '05': 'роорпЗ | May', '06': 'роЬрпВройрпН | Jun',
                        '07': 'роЬрпВро▓рпИ | Jul', '08': 'роЖроХро╕рпНроЯрпН | Aug', '09': 'роЪрпЖрокрпНроЯроорпНрокро░рпН | Sep',
                        '10': 'роЕроХрпНроЯрпЛрокро░рпН | Oct', '11': 'роиро╡роорпНрокро░рпН | Nov', '12': 'роЯро┐роЪроорпНрокро░рпН | Dec'
                    };
                    
                    return `
                        <div class="flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                            <div>
                                <span class="font-medium text-gray-800 dark:text-white">${monthNames[bill.month]} ${bill.year}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">${new Date(bill.updatedAt).toLocaleDateString()}</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="font-bold text-yellow-600 dark:text-yellow-400">тВ╣${bill.amount.toLocaleString('en-IN')}</span>
                                <button onclick="safeExecute(() => deleteElectricityBill('${bill.id}'))" class="text-red-500 hover:text-red-700 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function deleteElectricityBill(billId) {
            if (confirm('Are you sure you want to delete this bill?')) {
                appData.electricityBills = appData.electricityBills.filter(bill => bill.id !== billId);
                localStorage.setItem('electricityBills', JSON.stringify(appData.electricityBills));
                updateElectricityBillDisplay();
                showSuccess('Bill deleted successfully!');
            }
        }

        // ==================== LOCAL STORAGE BACKUP ====================
        function syncWithLocalStorage() {
            localStorage.setItem('familyAppData', JSON.stringify(appData));
        }

        function loadFromLocalStorage() {
            const localData = localStorage.getItem('familyAppData');
            if (localData) {
                return JSON.parse(localData);
            }
            return null;
        }

        function saveToLocalStorage(sheetName, data) {
            const key = `local_${sheetName}`;
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            existing.push({...data, localId: Date.now(), synced: false});
            localStorage.setItem(key, JSON.stringify(existing));
        }

        function syncLocalData() {
            ['local_products', 'local_expenses'].forEach(key => {
                const localData = JSON.parse(localStorage.getItem(key) || '[]');
                localData.forEach(item => {
                    if (!item.synced) {
                        const sheetName = key.replace('local_', '');
                        addSheetData(sheetName, item)
                            .then(() => {
                                item.synced = true;
                                localStorage.setItem(key, JSON.stringify(localData));
                            })
                            .catch(console.error);
                    }
                });
            });
        }

        // ==================== DATA MIGRATION ====================
        function migrateData() {
            const storedVersion = localStorage.getItem('appVersion');
            if (storedVersion !== APP_VERSION) {
                console.log('Migrating data from version', storedVersion, 'to', APP_VERSION);
                
                if (!appData.electricityBills) {
                    appData.electricityBills = [];
                }
                
                localStorage.setItem('appVersion', APP_VERSION);
                syncWithLocalStorage();
            }
        }

        // Auto-save every 30 seconds
        setInterval(syncWithLocalStorage, 30000);

        // ==================== NOTIFICATION SYSTEM ====================
        function checkAlertsAndNotifications() {
            const lowStockItems = appData.products.filter(p => p.current_stock < p.stock_quantity);
            if (lowStockItems.length > 0 && appData.settings.notifications) {
                showNotification(`${lowStockItems.length} items are low on stock!`, 'warning');
            }

            const today = new Date();
            if (today.getDate() === 25 && appData.settings.notifications) {
                showNotification('Monthly bills are due soon! ЁЯТб', 'info');
            }

            const totalSpending = appData.analytics.spending.total;
            if (totalSpending > appData.income * 0.8 && appData.settings.notifications) {
                showNotification('You\'ve spent 80% of your income! ЁЯТ░', 'warning');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            
            const colors = {
                info: 'bg-blue-100 border-blue-400 text-blue-700 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200',
                warning: 'bg-yellow-100 border-yellow-400 text-yellow-700 dark:bg-yellow-900 dark:border-yellow-700 dark:text-yellow-200',
                success: 'bg-green-100 border-green-400 text-green-700 dark:bg-green-900 dark:border-green-700 dark:text-green-200'
            };
            
            notification.className = `mt-4 px-4 py-3 rounded-lg border ${colors[type]} transition-all duration-300`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // ==================== QUICK ACTIONS ====================
        function setupQuickActions() {
            const t = translations[currentLanguage];
            const quickActionsHTML = `
                <button onclick="safeExecute(() => showModal('addProductModal'))" class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span class="text-sm font-medium">${t.quickAddProduct}</span>
                </button>
                <button onclick="safeExecute(() => showModal('addExpenseModal'))" class="p-3 bg-green-100 dark:bg-green-900 rounded-lg text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-800 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-receipt"></i>
                    <span class="text-sm font-medium">${t.quickAddExpense}</span>
                </button>
                <button onclick="safeExecute(() => showModal('dataManagementModal'))" class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span class="text-sm font-medium">${t.quickBackup}</span>
                </button>
                <button onclick="safeExecute(() => showTab('storeRoom'))" class="p-3 bg-orange-100 dark:bg-orange-900 rounded-lg text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors flex items-center justify-center space-x-2">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="text-sm font-medium">${t.quickCart}</span>
                </button>
            `;
            
            document.getElementById('quickActions').innerHTML = quickActionsHTML;
        }

        // ==================== DATA EXPORT/IMPORT ====================
        function exportData() {
            const data = {
                products: appData.products,
                expenses: appData.expenses,
                electricityBills: appData.electricityBills,
                income: appData.income,
                exportDate: new Date().toISOString(),
                version: APP_VERSION
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `family-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showSuccess('Data exported successfully!');
        }

        // Setup file import
        document.getElementById('importFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.products && data.expenses) {
                        appData.products = data.products;
                        appData.expenses = data.expenses;
                        appData.electricityBills = data.electricityBills || [];
                        appData.income = data.income || appData.income;
                        
                        generateAnalytics();
                        generateShoppingCart();
                        updateElectricityBillDisplay();
                        renderTabContent();
                        
                        showSuccess('Data imported successfully!');
                        hideModal('dataManagementModal');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    showError('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
                appData.products = [];
                appData.expenses = [];
                appData.electricityBills = [];
                appData.shoppingCart = [];
                generateAnalytics();
                renderTabContent();
                showSuccess('All data cleared!');
                hideModal('dataManagementModal');
            }
        }

        // ==================== PERIODIC CHECKS ====================
        function startPeriodicChecks() {
            setInterval(checkForUpdates, 24 * 60 * 60 * 1000);
            setInterval(checkAlertsAndNotifications, 60 * 60 * 1000);
            setInterval(() => {
                if (appData.settings.autoBackup) {
                    syncWithLocalStorage();
                }
            }, 6 * 60 * 60 * 1000);
        }

        // ==================== UPDATE MANAGEMENT ====================
        async function checkForUpdates() {
            try {
                const latestVersion = '2.1.0';
                
                if (latestVersion !== APP_VERSION) {
                    showUpdateNotification(latestVersion);
                }
            } catch (error) {
                console.log('Update check failed:', error);
            }
        }

        function showUpdateNotification(version) {
            const notification = document.getElementById('updateNotification');
            const title = document.getElementById('updateTitle');
            const message = document.getElementById('updateMessage');
            const changelog = document.getElementById('updateChangelog');
            const changelogList = document.getElementById('changelogList');
            
            if (!notification) return;
            
            title.textContent = currentLanguage === 'ta' ? 
                'рокрпБродро┐роп рокрпБродрпБрокрпНрокро┐рокрпНрокрпБ роХро┐роЯрпИроХрпНроХро┐ро▒родрпБ! ЁЯЪА' : 'New Update Available! ЁЯЪА';
            message.textContent = currentLanguage === 'ta' ?
                `рокродро┐рокрпНрокрпБ ${version} роХро┐роЯрпИроХрпНроХро┐ро▒родрпБ` : `Version ${version} is available`;
            
            const changes = currentLanguage === 'ta' ? [
                'рооро┐ройрпНроЪро╛ро░ рокро┐ро▓рпН роХрогрпНроХро╛рогро┐рокрпНрокрпБ',
                'роорпЗроорпНрокроЯрпНроЯ рокро┐ро┤рпИ роиро┐ро░рпНро╡ро╛роХроорпН',
                'роЖроГрокрпНро▓рпИройрпН роЖродро░ро╡рпБ',
                'родро░ро╡рпБ роЪро░ро┐рокро╛ро░рпНрокрпНрокрпБ'
            ] : [
                'Electricity bill tracking',
                'Improved error handling',
                'Offline support',
                'Data validation'
            ];
            
            changelogList.innerHTML = changes.map(change => `<li>${change}</li>`).join('');
            changelog.classList.remove('hidden');
            
            notification.classList.remove('hidden');
        }

        function hideUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            if (notification) {
                notification.classList.add('hidden');
            }
        }

        // ==================== UI MANAGEMENT ====================
        function updateUI() {
            const t = translations[currentLanguage];
            
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = t[key];
                }
            });
            
            const tabTitles = {
                home: t.tabHome,
                stock: t.tabStock,
                storeRoom: t.tabStoreRoom,
                prices: t.tabPrices,
                finance: t.tabFinance,
                settings: t.tabSettings
            };
            const activeTabTitle = document.getElementById('activeTabTitle');
            if (activeTabTitle) {
                activeTabTitle.textContent = tabTitles[currentTab] || t.tabHome;
            }
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ta' ? 'en' : 'ta';
            localStorage.setItem('language', currentLanguage);
            updateUI();
            setupQuickActions();
            renderTabContent();
        }

        function showTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                } else {
                    tab.classList.remove('bg-blue-600', 'text-white');
                    tab.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            });
            
            updateUI();
            renderTabContent();
        }

        // ==================== MODAL MANAGEMENT ====================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // ==================== NOTIFICATION HELPERS ====================
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            if (errorAlert) {
                errorAlert.textContent = translations[currentLanguage].error + ' ' + message;
                errorAlert.classList.remove('hidden');
                
                setTimeout(() => {
                    errorAlert.classList.add('hidden');
                }, 5000);
            }
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            if (successAlert) {
                successAlert.textContent = translations[currentLanguage].success + ' ' + message;
                successAlert.classList.remove('hidden');
                
                setTimeout(() => {
                    successAlert.classList.add('hidden');
                }, 3000);
            }
        }

        function getEmptyState(message, icon = 'fas fa-inbox') {
            return `
                <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                    <i class="${icon} text-4xl mb-3 opacity-50"></i>
                    <p class="text-lg">${message}</p>
                </div>
            `;
        }

        // ==================== FORM HANDLERS ====================
        async function handleAddProduct(event) {
            if (event) event.preventDefault();
            
            const formData = {
                name: document.getElementById('productName').value,
                type: document.getElementById('productType').value,
                stock_quantity: parseInt(document.getElementById('minStock').value),
                current_stock: 0,
                scale: document.getElementById('productScale').value,
                last_price: parseFloat(document.getElementById('lastPrice').value),
                frequency: document.getElementById('frequency').value,
                importance: parseInt(document.getElementById('importance').value)
            };
            
            try {
                const result = await addSheetData('products', formData);
                showSuccess('Product added successfully!');
                hideModal('addProductModal');
                document.getElementById('addProductForm').reset();
                
                await loadInitialData();
                renderTabContent();
                
            } catch (error) {
                showError(error.message);
            }
        }

        async function handleAddExpense(event) {
            if (event) event.preventDefault();
            
            const formData = {
                name: document.getElementById('expenseName').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                type: document.getElementById('expenseType').value
            };
            
            try {
                const result = await addSheetData('expenses', formData);
                showSuccess('Expense added successfully!');
                hideModal('addExpenseModal');
                document.getElementById('addExpenseForm').reset();
                
                await loadInitialData();
                renderTabContent();
                
            } catch (error) {
                showError(error.message);
            }
        }

        // ==================== ANALYTICS & SHOPPING CART ====================
        function generateAnalytics() {
            const totalSpent = appData.expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            const grocerySpending = appData.shoppingCart.reduce((sum, item) => sum + (item.last_price * item.needed), 0);
            const totalSpending = totalSpent + grocerySpending;
            
            appData.analytics = {
                spending: {
                    monthly: totalSpent,
                    grocery: grocerySpending,
                    total: totalSpending,
                    savingsRate: ((appData.income - totalSpending) / appData.income * 100).toFixed(1)
                },
                products: {
                    total: appData.products.length,
                    lowStock: appData.products.filter(p => p.current_stock < p.stock_quantity).length,
                    byCategory: {
                        grocery: appData.products.filter(p => p.type === 'Grocery').length,
                        essentials: appData.products.filter(p => p.type === 'HomeEssentials').length
                    }
                }
            };
        }

        function generateShoppingCart() {
            appData.shoppingCart = appData.products
                .filter(product => product.current_stock < product.stock_quantity)
                .map(product => ({
                    productId: product.id,
                    name: product.name,
                    needed: product.stock_quantity - product.current_stock,
                    last_price: product.last_price,
                    scale: product.scale,
                    importance: product.importance,
                    priority: calculatePriority(product)
                }))
                .sort((a, b) => b.priority - a.priority);
        }

        function calculatePriority(product) {
            const stockRatio = product.current_stock / product.stock_quantity;
            const urgency = 1 - stockRatio;
            return product.importance * urgency;
        }

        // ==================== TAB RENDERERS ====================
        function renderTabContent() {
            const tabContent = document.getElementById('tabContent');
            if (!tabContent) return;
            
            const t = translations[currentLanguage];
            
            switch(currentTab) {
                case 'home':
                    tabContent.innerHTML = renderHomeTab();
                    break;
                case 'stock':
                    tabContent.innerHTML = renderStockTab();
                    break;
                case 'storeRoom':
                    tabContent.innerHTML = renderStoreRoomTab();
                    break;
                case 'prices':
                    tabContent.innerHTML = renderAnalyticsTab();
                    break;
                case 'finance':
                    tabContent.innerHTML = renderFinanceTab();
                    break;
                case 'settings':
                    tabContent.innerHTML = renderSettingsTab();
                    break;
            }
        }

        function renderHomeTab() {
            const analytics = appData.analytics;
            const t = translations[currentLanguage];
            
            return `
                <div class="space-y-6">
                    <!-- Financial Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-green-500 transition-all duration-300 hover:shadow-xl">
                            <div class="flex justify-between items-start">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">${t.monthlyIncome}</h3>
                                <i class="fas fa-wallet text-green-500 text-xl"></i>
                            </div>
                            <div class="text-3xl font-bold mt-2 text-gray-800 dark:text-white">тВ╣${appData.income.toLocaleString('en-IN')}</div>
                            <div class="progress-bar mt-2" style="width: 100%"></div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-red-500 transition-all duration-300 hover:shadow-xl">
                            <div class="flex justify-between items-start">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">${t.totalSpent}</h3>
                                <i class="fas fa-chart-line text-red-500 text-xl"></i>
                            </div>
                            <div class="text-3xl font-bold mt-2 text-gray-800 dark:text-white">тВ╣${analytics.spending.total.toLocaleString('en-IN')}</div>
                            <div class="progress-bar mt-2 bg-red-500" style="width: ${Math.min((analytics.spending.total / appData.income * 100), 100)}%"></div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-blue-500 transition-all duration-300 hover:shadow-xl">
                            <div class="flex justify-between items-start">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">${t.amountSaved}</h3>
                                <i class="fas fa-piggy-bank text-blue-500 text-xl"></i>
                            </div>
                            <div class="text-3xl font-bold mt-2 ${analytics.spending.savingsRate >= 0 ? 'text-blue-600 dark:text-blue-400' : 'text-red-600 dark:text-red-400'}">
                                тВ╣${(appData.income - analytics.spending.total).toLocaleString('en-IN')}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">${analytics.spending.savingsRate}% savings rate</div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 transition-all duration-300 hover:shadow-xl">
                            <div class="flex justify-between items-start">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">${t.reserveCash}</h3>
                                <i class="fas fa-bullseye text-yellow-500 text-xl"></i>
                            </div>
                            <div class="text-3xl font-bold mt-2 text-gray-800 dark:text-white">
                                тВ╣${((appData.income - analytics.spending.total) * 0.5).toLocaleString('en-IN')}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">50% of savings</div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-center">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${appData.products.length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Total Products</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-center">
                            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${appData.products.filter(p => p.current_stock >= p.stock_quantity).length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Well Stocked</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-center">
                            <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${appData.products.filter(p => p.current_stock < p.stock_quantity).length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Low Stock</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-center">
                            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${appData.expenses.length}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Expenses</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStockTab() {
            const t = translations[currentLanguage];
            return `
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">${t.addNewProduct}</h2>
                            <button onclick="safeExecute(() => showModal('addProductModal'))" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>${t.addNewProduct}</span>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${appData.products.length > 0 ? appData.products.map(product => {
                                const importanceClass = product.importance === 3 ? 'importance-high' : 
                                                      product.importance === 2 ? 'importance-medium' : 'importance-low';
                                return `
                                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${importanceClass}">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-semibold text-gray-800 dark:text-white">${product.name}</h3>
                                        <div class="flex space-x-1">
                                            ${Array.from({length: 3}).map((_, i) => `
                                                <i class="fas fa-star ${i < product.importance ? 'text-yellow-500' : 'text-gray-300'}"></i>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                                        <div>роЗро░рпБрокрпНрокрпБ: ${product.current_stock} / ${product.stock_quantity} ${product.scale}</div>
                                        <div>ро╡ро┐ро▓рпИ: тВ╣${product.last_price}</div>
                                        <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full inline-block">
                                            ${product.frequency}
                                        </div>
                                    </div>
                                </div>
                            `}).join('') : getEmptyState('No products added yet', 'fas fa-boxes')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStoreRoomTab() {
            const t = translations[currentLanguage];
            const totalCost = appData.shoppingCart.reduce((sum, item) => sum + (item.last_price * item.needed), 0);
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">${t.shoppingList}</h2>
                            <div class="space-y-4">
                                ${appData.shoppingCart.length > 0 ? appData.shoppingCart.map(item => {
                                    const importanceClass = item.importance === 3 ? 'importance-high' : 
                                                          item.importance === 2 ? 'importance-medium' : 'importance-low';
                                    return `
                                    <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow ${importanceClass}">
                                        <div>
                                            <h3 class="font-semibold text-gray-800 dark:text-white">${item.name}</h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">ро╡ро┐ро▓рпИ: тВ╣${item.last_price}/${item.scale}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-blue-600 dark:text-blue-400">${item.needed} ${item.scale}</div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400">тВ╣${(item.last_price * item.needed).toLocaleString('en-IN')}</div>
                                        </div>
                                    </div>
                                `}).join('') : getEmptyState('All items are well stocked! ЁЯОЙ', 'fas fa-check-circle')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">${t.generateCart}</h2>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span>${t.totalItems}</span>
                                    <span class="font-bold">${appData.shoppingCart.length}</span>
                                </div>
                                <div class="flex justify-between text-lg font-bold border-t pt-3">
                                    <span>${t.estimatedBudget}</span>
                                    <span class="text-blue-600 dark:text-blue-400">тВ╣${totalCost.toLocaleString('en-IN')}</span>
                                </div>
                                <button onclick="safeExecute(() => showTab('prices'))" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors mt-4">
                                    ${t.proceedToBilling}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAnalyticsTab() {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">ро╡ро┐ро░ро┐ро╡ро╛рой рокроХрпБрокрпНрокро╛ропрпНро╡рпБ</h2>
                    <p class="text-gray-600 dark:text-gray-400">ро╡ро┐ро░ро┐ро╡ро╛рой рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роХро░рпБро╡ро┐роХро│рпН ро╡ро┐ро░рпИро╡ро┐ро▓рпН роХро┐роЯрпИроХрпНроХрпБроорпН</p>
                    <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-lg">
                        <p class="text-yellow-800 dark:text-yellow-200">Advanced analytics features coming soon!</p>
                    </div>
                </div>
            `;
        }

        function renderFinanceTab() {
            const t = translations[currentLanguage];
            const totalExpenses = appData.expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
            const netSavings = appData.income - totalExpenses;
            
            return `
                <div class="space-y-6">
                    <!-- Electricity Bill Section -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center space-x-2">
                            <i class="fas fa-bolt text-yellow-500"></i>
                            <span>рооро┐ройрпНроЪро╛ро░ рокро┐ро▓рпН роХрогрпНроХро╛рогро┐рокрпНрокрпБ | Electricity Bill Tracking</span>
                        </h3>
                        
                        <!-- Current Month Bill -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-300">родро▒рпНрокрпЛродрпИроп рооро╛род рокро┐ро▓рпН</p>
                                        <p class="text-2xl font-bold text-gray-800 dark:text-white" id="currentElectricityBill">тВ╣0</p>
                                    </div>
                                    <i class="fas fa-bolt text-blue-500 text-2xl"></i>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-sm text-gray-600 dark:text-gray-300">роЪро░ро╛роЪро░ро┐ рооро╛род рокро┐ро▓рпН</p>
                                        <p class="text-2xl font-bold text-gray-800 dark:text-white" id="averageElectricityBill">тВ╣0</p>
                                    </div>
                                    <i class="fas fa-chart-line text-green-500 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add New Bill Form -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-900">
                            <h4 class="font-semibold text-gray-800 dark:text-white mb-3">рокрпБродро┐роп рокро┐ро▓рпН роЪрпЗро░рпНроХрпНроХ | Add New Bill</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">рооро╛родроорпН | Month</label>
                                    <select id="billMonth" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        ${Array.from({length: 12}, (_, i) => {
                                            const monthNum = String(i + 1).padStart(2, '0');
                                            const monthNames = [
                                                'роЬройро╡ро░ро┐ | January', 'рокро┐рокрпНро░ро╡ро░ро┐ | February', 'рооро╛ро░рпНроЪрпН | March',
                                                'роПрокрпНро░ро▓рпН | April', 'роорпЗ | May', 'роЬрпВройрпН | June',
                                                'роЬрпВро▓рпИ | July', 'роЖроХро╕рпНроЯрпН | August', 'роЪрпЖрокрпНроЯроорпНрокро░рпН | September',
                                                'роЕроХрпНроЯрпЛрокро░рпН | October', 'роиро╡роорпНрокро░рпН | November', 'роЯро┐роЪроорпНрокро░рпН | December'
                                            ];
                                            const selected = monthNum === String(new Date().getMonth() + 1).padStart(2, '0') ? 'selected' : '';
                                            return `<option value="${monthNum}" ${selected}>${monthNames[i]}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">роЖрогрпНроЯрпБ | Year</label>
                                    <select id="billYear" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="2024">2024</option>
                                        <option value="2025" selected>2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">родрпКроХрпИ | Amount (тВ╣)</label>
                                    <input type="number" id="billAmount" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="1500" min="0">
                                </div>
                            </div>
                            <button onclick="safeExecute(addElectricityBill)" class="w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold hover:bg-yellow-700 transition-colors mt-3 flex items-center justify-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>рокро┐ро▓рпН роЪрпЗро░рпНроХрпНроХ | Add Bill</span>
                            </button>
                        </div>
                        
                        <!-- Bill History -->
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 dark:text-white mb-3">рокро┐ро▓рпН ро╡ро░ро▓ро╛ро▒рпБ | Bill History</h4>
                            <div id="electricityBillHistory" class="space-y-2 max-h-60 overflow-y-auto">
                                ${appData.electricityBills && appData.electricityBills.length > 0 ? '' : getEmptyState('No bills recorded yet', 'fas fa-bolt')}
                            </div>
                        </div>
                    </div>

                    <!-- Regular Finance Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">${t.incomeExpenseEntry}</h2>
                                    <button onclick="safeExecute(() => showModal('addExpenseModal'))" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                                        <i class="fas fa-plus"></i>
                                        <span>${t.addNewExpense}</span>
                                    </button>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">${t.totalIncome}</h3>
                                    <div class="flex space-x-3">
                                        <input type="number" id="incomeInput" value="${appData.income}" 
                                               class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                               onchange="appData.income = parseFloat(this.value) || 0; renderTabContent(); showSuccess('Income updated!');">
                                        <button onclick="appData.income = parseFloat(document.getElementById('incomeInput').value) || 0; renderTabContent(); showSuccess('Income updated!');" 
                                                class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">${t.expenses}</h3>
                                <div class="space-y-3">
                                    ${appData.expenses.length > 0 ? appData.expenses.map(expense => `
                                        <div class="flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition-shadow">
                                            <div>
                                                <h3 class="font-semibold text-gray-800 dark:text-white">${expense.name}</h3>
                                                <span class="text-xs ${expense.type === 'Fixed' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'} px-2 py-1 rounded-full">
                                                    ${expense.type}
                                                </span>
                                            </div>
                                            <span class="font-bold text-red-600 dark:text-red-400">тВ╣${parseFloat(expense.amount).toLocaleString('en-IN')}</span>
                                        </div>
                                    `).join('') : getEmptyState('No expenses added yet', 'fas fa-receipt')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">${t.financialSummary}</h2>
                                <div class="space-y-4">
                                    <div class="flex justify-between">
                                        <span>${t.totalIncome}:</span>
                                        <span class="font-bold text-green-600 dark:text-green-400">тВ╣${appData.income.toLocaleString('en-IN')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>${t.totalSpentSummary}:</span>
                                        <span class="font-bold text-red-600 dark:text-red-400">тВ╣${totalExpenses.toLocaleString('en-IN')}</span>
                                    </div>
                                    <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                        <div class="flex justify-between font-bold text-lg">
                                            <span>${t.amountSavedSummary}:</span>
                                            <span class="${netSavings >= 0 ? 'text-blue-600 dark:text-blue-400' : 'text-red-600 dark:text-red-400'}">
                                                тВ╣${netSavings.toLocaleString('en-IN')}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                                        <span>${t.reserveCashTarget}:</span>
                                        <span class="font-semibold">тВ╣${(netSavings > 0 ? netSavings * 0.5 : 0).toLocaleString('en-IN')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettingsTab() {
            return `
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Application Settings</h2>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-white">Dark Mode</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Toggle between dark and light theme</p>
                                </div>
                                <button onclick="safeExecute(toggleThemeSetting)" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors">
                                    <span class="inline-block h-4 w-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-white">Auto Backup</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Automatically backup data every 6 hours</p>
                                </div>
                                <button onclick="safeExecute(toggleAutoBackup)" class="relative inline-flex h-6 w-11 items-center rounded-full ${appData.settings.autoBackup ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'} transition-colors">
                                    <span class="inline-block h-4 w-4 transform bg-white rounded-full transition-transform ${appData.settings.autoBackup ? 'translate-x-6' : 'translate-x-1'}"></span>
                                </button>
                            </div>
                            
                            <div class="flex justify-between items-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-white">Notifications</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Show alerts and reminders</p>
                                </div>
                                <button onclick="safeExecute(toggleNotifications)" class="relative inline-flex h-6 w-11 items-center rounded-full ${appData.settings.notifications ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-700'} transition-colors">
                                    <span class="inline-block h-4 w-4 transform bg-white rounded-full transition-transform ${appData.settings.notifications ? 'translate-x-6' : 'translate-x-1'}"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Data Management</h2>
                        <button onclick="safeExecute(() => showModal('dataManagementModal'))" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                            Open Data Management
                        </button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">About</h2>
                        <div class="space-y-2 text-gray-600 dark:text-gray-400">
                            <p><strong>Version:</strong> ${APP_VERSION}</p>
                            <p><strong>Designed for:</strong> Family Use</p>
                            <p><strong>Data Storage:</strong> Google Sheets + Local Backup</p>
                            <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleThemeSetting() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeToggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            appData.settings.darkMode = isDark;
            syncWithLocalStorage();
        }

        function toggleAutoBackup() {
            appData.settings.autoBackup = !appData.settings.autoBackup;
            showSuccess(`Auto backup ${appData.settings.autoBackup ? 'enabled' : 'disabled'}`);
            syncWithLocalStorage();
            renderTabContent();
        }

        function toggleNotifications() {
            appData.settings.notifications = !appData.settings.notifications;
            showSuccess(`Notifications ${appData.settings.notifications ? 'enabled' : 'disabled'}`);
            syncWithLocalStorage();
            renderTabContent();
        }

        // Initialize electricity bills after finance tab is rendered
        setTimeout(() => {
            if (currentTab === 'finance') {
                updateElectricityBillDisplay();
            }
        }, 100);

        // Initial update check
        setTimeout(checkForUpdates, 5000);
    </script>
</body>
</html>
